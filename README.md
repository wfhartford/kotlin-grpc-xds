

# Kustomize

Kustomization is a little strange in this project.

The goal was to have all the manifests in the manifests directory, simple
enough right? The problem is using a `:latest` label in a deployment manifest
is a pain because the image won't get pulled when you redeploy. The preferred
solution to that is to use an image digest in the deployment so that the
deployment references a specific image rather than just whatever is _latest_.
Using a digest means having the gradle build generate at least some part of
the digests that get deployed because the gradle build is generating the
image using jib, which makes a nice file for us containing the digest. It
seems like the build should be able to just generate the image transformer
part of the kustomize manifest, which looks something like this:

```
images:
  - name: server
    newName: quay.io/wfhartford/kotlin-grpc-xds/server
    digest: sha256:58669b3df216d605259625283d3b1412d77090fc4151642b79364fc4e3578bd4
```

Unfortunately, I can't find any way to have kustomize just pull in an image
transformer from a separate file.

## Manifest Layout

Here's the manifest layout I ended up with:

| Path                                                                                          | Description                                                                                                                                                                                                  |
|-----------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| `/kustomization.yaml`                                                                         | Main kustomization file, lets you run `kubectl apply -k .` from the project root dir. This references the static manifests in `/manifests` and the `kustomization.yaml` files generated by the gradle build. |
| `/manifests`                                                                                  | Directory containing static manifests that don't need to have build time kustomizations applied.  These are referenced by the main `/kustomization.yaml` file                                                |
| `/client/src/main/k8s` and `/server/src/main/k8s`                                             | Project specific manifests which have build time kustomizations applied to them. These are referenced by the `kustomization.yaml` files generated by the gradle build.                                       |
| `/client/build/kustomize/kustomization.yaml` and `/server/build/kustomize/kustomization.yaml` | Kustomization files generated by the gradle build. These include the image transformer which applies the image hash.                                                                                         |
